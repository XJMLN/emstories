local spawnData = {
    {x=-1095.47,y=-802.59,z=18.66,heading=35.27,model="a_m_m_farmer_01",skipFade=false},
    {x=1857.37,y=3679.15,z=33.76,heading=192.44,model="a_m_m_farmer_01",skipFade=false},
    {x=-438.06,y=6021.48,z=31.49,heading=305.66,model="a_m_m_farmer_01",skipFade=false},
  }
  
  local isDead = false 
  local timerCount = 90
  DecorRegister("selectedSpawn",3)
  AddEventHandler('onClientMapStart', function()
  
    exports.spawnmanager:setAutoSpawn(false)
  end)
  local selectedSpawn = false
  local showedSpawner = false 
  local secureUI = false
  
  function showUI()
    showedSpawner = false
    SetManualShutdownLoadingScreenNui(true)
    ShutdownLoadingScreen()
    ShutdownLoadingScreenNui()
    Citizen.SetTimeout(30000,function()
      TriggerServerEvent("spawner:checkNewPlayer")
    end)
    Wait(2500)
    SetNuiFocus(true, true)
    SendNUIMessage({type = "open_spawnSelector"})
    secureUI = true
  end
  
  Citizen.CreateThread(function()
    if (not showedSpawner) then 
      showUI()
    end
  end)
  
  RegisterNUICallback("spawnPlayer", function(data, callback)
    if (not secureUI) then return end
    SetNuiFocus(false)
  
    local spawnNumber = tonumber(data.spawnNumber)
    exports.spawnmanager:spawnPlayer(spawnData[spawnNumber])
    selectedSpawn = spawnNumber
    DecorSetInt(PlayerPedId(-1),"selectedSpawn",spawnNumber)
    isDead = false 
      timerCount = 90 
    secureUI = false
    local template = '<div style="padding: 0.5vw; margin: 0.5vw; background-color: rgba(31,166,122, 0.6); border-radius: 3px;word-break:break-word;"><i class="fa fa-info-circle"></i> Witaj na serwerze Kaktusownia FivePD. Zapoznaj się z poradnikiem (klawisz F1), aby dowiedzieć się o podstawach gry na serwerze.</div>'
              TriggerEvent('chat:addMessage',{
                  template = template,
              })
    callback("ok")
  end)
  
  function spawnPlayerAfterDeath()
      local spawnNumber = selectedSpawn
      if (spawnNumber>0) then 
      Citizen.Wait(500)
          exports.spawnmanager:spawnPlayer(spawnData[spawnNumber])
      end
  end
  
  function revivePed(ped)
  
      ClearPrints()
      SetPlayerInvincible(ped,false)
      ClearPedBloodDamage(ped)
      SetNuiFocus(true, true)
      Citizen.Wait(500)
    secureUI = true
      SendNUIMessage({type = "open_spawnSelector"})
  end
  
  function DrawDialogueTexts(text,time)
      
      SetTextEntry_2("STRING")
      AddTextComponentString(text)
      DrawSubtitleTimed(time, 1)
  end
  Citizen.CreateThread(function()
      while true do
      Citizen.Wait(0)
          ped = GetPlayerPed(-1)
  
          if IsEntityDead(ped) then
                  isDead = true
              SetPlayerInvincible(ped, true)
              SetEntityHealth(ped, 1)
              
              if (timerCount > 0) then 
                  exports.fpd_3dtext:Draw2DText({text="Odrodzenie możliwe za ~g~"..timerCount.."~w~ sekund" or "",font=0,x=0.4,y=0.97,scale=0.4,outline=true})
              else
                  exports.fpd_3dtext:Draw2DText({text="Twoja postać jest martwa, wciśnij '~r~E~w~' aby się odrodzić." or "",font=0,x=0.3,y=0.97,scale=0.4,outline=true})
              end
              if IsControlJustReleased(0, 38) then
                  if timerCount <= 0 then
                      
                      revivePed(ped)
                  end
              end
          end
      end
  end)
  
  Citizen.CreateThread(function()
      while true do
        ped = GetPlayerPed(-1)
        if IsEntityDead(ped) then
                timerCount = timerCount - 1
        end
          Citizen.Wait(1000)
      end
  end)
  
  function adminRevivePlayer()
    local ped = GetPlayerPed(-1)
    if (IsEntityDead(ped)) then 
      revivePed(GetPlayerPed(-1))
    end
  end
  RegisterNetEvent("spawner:adminRevivePlayer")
  AddEventHandler("spawner:adminRevivePlayer",adminRevivePlayer)